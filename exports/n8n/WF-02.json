{
  "name": "WF-02 Research & Source Intake",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "wf-02",
        "responseMode": "lastNode",
        "options": {
          "responseData": "firstEntryJson"
        }
      },
      "id": "1",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [0, 0],
      "webhookId": "wf-02-trigger"
    },
    {
      "parameters": {
        "language": "javascript",
        "code": "const now = new Date().toISOString();\nconst input = $json;\n\ntry {\n  // Input comes directly from WF-01, not wrapped in contract_json\n  const contract = input;\n  const resolvedConfig = contract.resolved_config || {};\n  \n  // Get sources from input or generate default based on topic\n  let sources = [];\n  if (input.sources_json) {\n    sources = JSON.parse(input.sources_json);\n  } else if (input.sources && Array.isArray(input.sources)) {\n    sources = input.sources;\n  } else {\n    // Auto-generate placeholder sources based on topic\n    const topic = contract.manifest?.topic?.title || 'Research Topic';\n    sources = [\n      {\n        title: `${topic} - Primary Source`,\n        url: 'https://example.org/source-1',\n        license: 'CC-BY-4.0'\n      }\n    ];\n  }\n\n  if (!contract.manifest || !contract.manifest.topic) {\n    throw new Error('invalid_manifest');\n  }\n\n  contract.manifest.audit.change_log.push({\n    at: now,\n    by: 'wf-02',\n    change: `step=wf-02 status=STARTED run_id=${contract.run_id} mode=${contract.mode}`\n  });\n\n  contract.manifest.topic.source_references = sources;\n  contract.manifest.timestamps.phase = 'research';\n  contract.manifest.timestamps.updated_at = now;\n  contract.manifest.audit.updated_by = 'wf-02';\n\n  contract.manifest.audit.change_log.push({\n    at: now,\n    by: 'wf-02',\n    change: `step=wf-02 status=COMPLETED run_id=${contract.run_id} mode=${contract.mode} sources=${sources.length}`\n  });\n\n  return [\n    {\n      json: {\n        run_id: contract.run_id,\n        mode: contract.mode,\n        scene_assets: contract.scene_assets || [],\n        voiceover_url_signed: contract.voiceover_url_signed,\n        render_id: contract.render_id,\n        youtube_video_id: contract.youtube_video_id,\n        manifest: contract.manifest,\n        resolved_config: resolvedConfig,\n        environment: contract.environment,\n        scope: contract.scope,\n        channel_id: contract.channel_id,\n        runtime_overrides: contract.runtime_overrides,\n        worker: 'WF-02',\n        status: 'COMPLETED',\n        output_summary: `updated topic.source_references (${sources.length})`\n      }\n    }\n  ];\n} catch (error) {\n  const message = error && error.message ? error.message : 'unknown_error';\n  const fallback = input;\n  \n  if (fallback.manifest && fallback.manifest.timestamps) {\n    fallback.manifest.timestamps.phase = 'failed_wf_02';\n    fallback.manifest.timestamps.updated_at = now;\n    fallback.manifest.audit.change_log.push({\n      at: now,\n      by: 'wf-02',\n      change: `step=wf-02 status=FAILED error_code=FAILED_WF_02 error_message=${message} run_id=${fallback.run_id} mode=${fallback.mode}`\n    });\n  }\n  \n  return [\n    {\n      json: {\n        run_id: fallback.run_id || null,\n        mode: fallback.mode || null,\n        scene_assets: fallback.scene_assets || [],\n        voiceover_url_signed: fallback.voiceover_url_signed || null,\n        render_id: fallback.render_id || null,\n        youtube_video_id: fallback.youtube_video_id || null,\n        manifest: fallback.manifest || null,\n        resolved_config: fallback.resolved_config || null,\n        worker: 'WF-02',\n        status: 'FAILED_WF_02',\n        output_summary: `error=${message}`\n      }\n    }\n  ];\n}"
      },
      "id": "3",
      "name": "Apply Research Sources",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [260, 0]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Apply Research Sources",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "00000000-0000-0000-0000-000000000002",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "id": "2"
}
