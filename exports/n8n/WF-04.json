{
  "name": "WF-04 Script Review & Approval",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "wf-04",
        "responseMode": "lastNode",
        "options": {
          "responseData": "firstEntryJson"
        }
      },
      "id": "1",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [0, 0],
      "webhookId": "wf-04-trigger"
    },
    {
      "parameters": {
        "language": "javascript",
        "code": "const now = new Date().toISOString();\nconst input = $json;\n\ntry {\n  const contract = input;\n  const resolvedConfig = contract.resolved_config || {};\n\n  if (!contract.manifest || !contract.manifest.script) {\n    throw new Error('invalid_manifest');\n  }\n\n  contract.manifest.audit.change_log.push({\n    at: now,\n    by: 'wf-04',\n    change: `step=wf-04 status=STARTED run_id=${contract.run_id} mode=${contract.mode}`\n  });\n\n  // Get the draft script\n  const draftScript = contract.manifest.script.draft || '';\n  \n  if (!draftScript || draftScript.length < 100) {\n    throw new Error('no_draft_script');\n  }\n\n  // In auto-approval mode (for automation), approve the draft as-is\n  // In manual mode, review_notes and approved_script would come from input\n  const reviewNotes = input.review_notes || 'Auto-approved by WF-04';\n  const approvedScript = input.approved_script || draftScript;\n\n  // Update manifest\n  contract.manifest.script.approved = approvedScript;\n  contract.manifest.script.review_notes = Array.isArray(contract.manifest.script.review_notes) \n    ? [...contract.manifest.script.review_notes, reviewNotes]\n    : [reviewNotes];\n  contract.manifest.script.last_reviewed_at = now;\n  contract.manifest.timestamps.phase = 'script_approved';\n  contract.manifest.timestamps.updated_at = now;\n  contract.manifest.audit.updated_by = 'wf-04';\n\n  // Generate YouTube metadata from script\n  const topic = contract.manifest.topic || {};\n  const channelName = resolvedConfig.branding?.channel_name || 'Helal Elm';\n  const defaultTags = resolvedConfig.branding?.default_tags || ['elm', 'maarif', 'azərbaycanca'];\n  \n  contract.manifest.publish.title = topic.title || 'Video';\n  contract.manifest.publish.description = `${topic.summary || ''}\\n\\n${channelName} kanalından maarifləndirici video.\\n\\n#${topic.keywords?.join(' #') || 'elm'}`;\n  contract.manifest.publish.tags = [...defaultTags, ...(topic.keywords || [])];\n  contract.manifest.publish.channel_id = contract.channel_id || resolvedConfig.publish?.channel_id || '';\n\n  contract.manifest.audit.change_log.push({\n    at: now,\n    by: 'wf-04',\n    change: `step=wf-04 status=COMPLETED run_id=${contract.run_id} mode=${contract.mode} notes=1`\n  });\n\n  return [\n    {\n      json: {\n        run_id: contract.run_id,\n        mode: contract.mode,\n        scene_assets: contract.scene_assets || [],\n        voiceover_url_signed: contract.voiceover_url_signed,\n        render_id: contract.render_id,\n        youtube_video_id: contract.youtube_video_id,\n        manifest: contract.manifest,\n        resolved_config: resolvedConfig,\n        environment: contract.environment,\n        scope: contract.scope,\n        channel_id: contract.channel_id,\n        runtime_overrides: contract.runtime_overrides,\n        worker: 'WF-04',\n        status: 'COMPLETED',\n        output_summary: 'script approved and youtube metadata generated'\n      }\n    }\n  ];\n} catch (error) {\n  const message = error && error.message ? error.message : 'unknown_error';\n  const fallback = input;\n  \n  if (fallback.manifest && fallback.manifest.timestamps) {\n    fallback.manifest.timestamps.phase = 'failed_wf_04';\n    fallback.manifest.timestamps.updated_at = now;\n    fallback.manifest.audit.change_log.push({\n      at: now,\n      by: 'wf-04',\n      change: `step=wf-04 status=FAILED error_code=FAILED_WF_04 error_message=${message} run_id=${fallback.run_id} mode=${fallback.mode}`\n    });\n  }\n  \n  return [\n    {\n      json: {\n        run_id: fallback.run_id || null,\n        mode: fallback.mode || null,\n        scene_assets: fallback.scene_assets || [],\n        voiceover_url_signed: fallback.voiceover_url_signed || null,\n        render_id: fallback.render_id || null,\n        youtube_video_id: fallback.youtube_video_id || null,\n        manifest: fallback.manifest || null,\n        resolved_config: fallback.resolved_config || null,\n        worker: 'WF-04',\n        status: 'FAILED_WF_04',\n        output_summary: `error=${message}`\n      }\n    }\n  ];\n}"
      },
      "id": "2",
      "name": "Approve Script",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [260, 0]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [{"node": "Approve Script", "type": "main", "index": 0}]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "00000000-0000-0000-0000-000000000004",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "id": "4"
}
